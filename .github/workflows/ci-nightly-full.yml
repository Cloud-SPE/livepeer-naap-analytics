name: CI Nightly Full

on:
  schedule:
    - cron: "30 7 * * *"
  workflow_dispatch:

jobs:
  eligibility:
    name: Nightly Eligibility Check
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.gate.outputs.should_run }}
      reason: ${{ steps.gate.outputs.reason }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Evaluate Branch + Recent Changes
        id: gate
        shell: bash
        run: |
          BRANCH="${GITHUB_REF_NAME}"
          if [[ "${BRANCH}" != "main" && "${BRANCH}" != "master" ]]; then
            echo "should_run=false" >> "$GITHUB_OUTPUT"
            echo "reason=unsupported_branch_${BRANCH}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          RECENT_COMMITS="$(git rev-list --count --since='24 hours ago' HEAD)"
          if [[ "${RECENT_COMMITS}" -eq 0 ]]; then
            echo "should_run=false" >> "$GITHUB_OUTPUT"
            echo "reason=no_commits_last_24h" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "should_run=true" >> "$GITHUB_OUTPUT"
          echo "reason=eligible_branch_and_recent_commits" >> "$GITHUB_OUTPUT"

      - name: Eligibility Summary
        run: |
          {
            echo "## Nightly Eligibility"
            echo ""
            echo "- branch: \`${GITHUB_REF_NAME}\`"
            echo "- should_run: \`${{ steps.gate.outputs.should_run }}\`"
            echo "- reason: \`${{ steps.gate.outputs.reason }}\`"
          } >> "$GITHUB_STEP_SUMMARY"

  nightly-full:
    name: Full Integration Harness
    runs-on: ubuntu-latest
    needs: eligibility
    if: ${{ needs.eligibility.outputs.should_run == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Set up uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true

      - name: Docker Compose Version
        run: docker compose version

      - name: Run Full Harness
        run: |
          python3 tests/python/scripts/run_scenario_test_harness.py \
            --mode full \
            --compose-files docker-compose.yml,docker-compose.scenario.yml \
            --down-volumes \
            --window-source manifest \
            --python-runner uv

      - name: Write Full Summary
        if: always()
        run: |
          python3 - <<'PY'
          import json
          from pathlib import Path

          root = Path("artifacts/test-runs")
          runs = sorted([p for p in root.glob("*") if p.is_dir()])
          if not runs:
              print("No harness run artifacts found.")
              raise SystemExit(0)

          latest = runs[-1]
          summary_path = latest / "summary.json"
          if not summary_path.exists():
              print(f"Summary missing: {summary_path}")
              raise SystemExit(0)

          payload = json.loads(summary_path.read_text(encoding="utf-8"))
          results = payload.get("results", [])
          total = len(results)
          failed = sum(1 for r in results if r.get("status") != "passed")
          passed = total - failed

          lines = []
          lines.append("## Nightly Full Harness Summary")
          lines.append("")
          lines.append(f"- run_id: `{payload.get('run_id', latest.name)}`")
          lines.append(f"- passed stages: `{passed}`")
          lines.append(f"- failed stages: `{failed}`")
          lines.append("")
          lines.append("| Stage | Status | Duration (s) |")
          lines.append("|---|---|---:|")
          for r in results:
              lines.append(f"| `{r.get('stage','')}` | `{r.get('status','')}` | {r.get('duration_sec',0):.2f} |")

          summary = Path.home() / "summary.md"
          summary.write_text("\n".join(lines) + "\n", encoding="utf-8")
          print(summary.read_text(encoding="utf-8"))
          PY
          cat ~/summary.md >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Harness Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-full-artifacts
          path: artifacts/test-runs/
          if-no-files-found: ignore

  nightly-skipped:
    name: Nightly Skipped
    runs-on: ubuntu-latest
    needs: eligibility
    if: ${{ needs.eligibility.outputs.should_run != 'true' }}
    steps:
      - name: Write Skip Summary
        run: |
          {
            echo "## Nightly Full Harness Skipped"
            echo ""
            echo "- branch: \`${GITHUB_REF_NAME}\`"
            echo "- reason: \`${{ needs.eligibility.outputs.reason }}\`"
          } >> "$GITHUB_STEP_SUMMARY"
